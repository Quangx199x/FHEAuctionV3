<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHEVM Public Key Getter</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        h1 { color: #00ff00; }
        #output {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #333;
            min-height: 200px;
        }
        button {
            padding: 10px 20px;
            background: #007700;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover {
            background: #009900;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .success { color: #00ff00; }
        .error { color: #ff3333; }
        .info { color: #00aaff; }
        p {
            margin: 3px 0;
            line-height: 1.3;
        }
        .key-box {
            background: #111;
            border: 1px solid #00ff00;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            word-break: break-all;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>FHEVM Public Key Getter</h1>
    <p>Fetching public key from Zama Sepolia testnet...</p>
    <button id="btn" onclick="getPublicKeyFn()">Get Public Key from Sepolia</button>
    <div id="output"></div>

    <script type="module">
        const outputDiv = document.getElementById('output');
        const btn = document.getElementById('btn');

        function log(msg, type = 'normal') {
            console.log(msg);
            const p = document.createElement('p');
            p.textContent = msg;
            if (type === 'success') p.className = 'success';
            if (type === 'error') p.className = 'error';
            if (type === 'info') p.className = 'info';
            outputDiv.appendChild(p);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        async function getPublicKeyFn() {
            btn.disabled = true;
            outputDiv.innerHTML = '';
            
            try {
                log('üîç ƒêang l·∫•y Public Key FHE t·ª´ Sepolia...', 'info');
                
                // Step 1: Import required libraries
                log('‚è≥ Loading libraries...', 'info');
                const { ethers } = await import('https://cdn.jsdelivr.net/npm/ethers@6/+esm');
                log('‚úÖ Ethers loaded', 'success');

                // Step 2: Import FHEVM SDK properly
                log('‚è≥ Loading FHEVM SDK...', 'info');
                const fhevmModule = await import('https://cdn.jsdelivr.net/npm/@fhevm/sdk@0.7.0-20/+esm');
                const { initFhevm, createInstance } = fhevmModule;
                log('‚úÖ FHEVM SDK loaded', 'success');

                // Step 3: Initialize FHEVM
                log('‚è≥ Initializing FHEVM (loading WASM)...', 'info');
                await initFhevm();
                log('‚úÖ FHEVM initialized with WASM', 'success');

                // Step 4: Create provider to Sepolia
                log('‚è≥ Connecting to Sepolia RPC...', 'info');
                const rpcUrl = 'https://rpc.ankr.com/eth_sepolia/189b7c1c563d4bba2186e34fbc1a96e2a0a75e413c377deca746ed206713700c';
                const provider = new ethers.JsonRpcProvider(rpcUrl);
                
                // Test connection
                const network = await provider.getNetwork();
                log(`‚úÖ Connected to network (chainId: ${network.chainId})`, 'success');

                // Step 5: Create FHEVM instance with Sepolia config
                log('‚è≥ Creating FHEVM instance...', 'info');
                const instance = await createInstance({
                    provider,
                    verifyingContractAddress: "0x7048C39f048125eDa9d678AEbaDfB22F7900a29F",
                    kmsContractAddress: "0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC",
                    aclContractAddress: "0x687820221192C5B662b25367F70076A37bc79b6c",
                    relayerUrl: "https://relayer.testnet.zama.cloud",
                    gatewayUrl: "https://gateway.sepolia.zama.ai/",
                    gatewayChainId: 11155111,
                });
                log('‚úÖ FHEVM instance created', 'success');

                // Step 6: Get public key
                log('‚è≥ Fetching public key from instance...', 'info');
                const fhePublicKey = instance.publicKey;
                
                if (!fhePublicKey) {
                    throw new Error('Public key is undefined - check relayer/gateway connectivity');
                }

                // Success!
                log('', 'success');
                log('----- SUCCESS -----', 'success');
                log('‚úÖ Public Key FHE l·∫•y th√†nh c√¥ng!', 'success');
                log('----- END -----', 'success');
                log('', 'success');
                
                log('üìù Public Key FHE:', 'info');
                const keyBox = document.createElement('div');
                keyBox.className = 'key-box';
                keyBox.textContent = fhePublicKey;
                outputDiv.appendChild(keyBox);
                
                log('', 'info');
                log('‚úÇÔ∏è Use in your code:', 'info');
                const codeBox = document.createElement('div');
                codeBox.className = 'key-box';
                codeBox.textContent = `const PUBLIC_KEY = '${fhePublicKey}';`;
                outputDiv.appendChild(codeBox);

            } catch (error) {
                log('', 'error');
                log('‚ùå ERROR OCCURRED', 'error');
                log(`Message: ${error.message}`, 'error');
                log('', 'error');
                
                // Suggestions
                if (error.message.includes('WASM') || error.message.includes('WebAssembly')) {
                    log('üí° Suggestion: WASM loading issue - try clearing browser cache', 'info');
                    log('üí° Or use incognito/private window', 'info');
                } else if (error.message.includes('gateway') || error.message.includes('relayer')) {
                    log('üí° Suggestion: Relayer/Gateway connectivity issue', 'info');
                    log('üí° Check: https://relayer.testnet.zama.cloud/health', 'info');
                } else if (error.message.includes('not a function')) {
                    log('üí° Suggestion: SDK import issue - SDK version mismatch', 'info');
                    log('üí° Try refreshing the page', 'info');
                }
                
                console.error('Full error:', error);
            } finally {
                btn.disabled = false;
            }
        }

        // Auto-run on page load
        window.getPublicKeyFn = getPublicKeyFn;
    </script>
</body>
</html>